# app.py
import streamlit as st
import streamlit.components.v1 as components
from datetime import datetime

# ëª¨ë“ˆ ì„í¬íŠ¸
import config
import auth
import data
import views
from utils import WEEK_MAP

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    layout="wide", 
    page_title="ì¿¡ì•¤ì…°í”„ ì£¼ê°„ ì„±ê³¼ë³´ê³ ì„œ", 
    page_icon="ğŸ“°", 
    initial_sidebar_state="collapsed"
)

# 2. ìŠ¤íƒ€ì¼ ì ìš©
st.markdown(config.CSS, unsafe_allow_html=True)
st.markdown(config.PRINT_CSS, unsafe_allow_html=True)

# 3. ë³´ì•ˆ ì²´í¬
if not auth.check_password():
    st.stop()

# =================================================================
# â–¼ ë©”ì¸ ë¡œì§ ì‹œì‘ â–¼
# =================================================================

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'print_mode' not in st.session_state:
    st.session_state['print_mode'] = False

# ìƒë‹¨ í—¤ë” ì˜ì—­
c1, c2 = st.columns([2, 1])
with c1: 
    st.markdown('<div class="report-title">ğŸ“° ì¿¡ì•¤ì…°í”„ ì£¼ê°„ ì„±ê³¼ë³´ê³ ì„œ</div>', unsafe_allow_html=True)

with c2:
    col_btn1, col_btn2 = st.columns(2)
    # ì¸ì‡„ ëª¨ë“œ í† ê¸€ ë²„íŠ¼
    if st.session_state['print_mode']:
        if col_btn1.button("ğŸ”™ ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€", type="secondary"):
            st.session_state['print_mode'] = False
            st.rerun()
        if col_btn2.button("ğŸ–¨ï¸ ì¸ì‡„ ì‹¤í–‰", type="primary"):
            st.components.v1.html("<script>window.parent.print();</script>", height=0, width=0)
    else:
        if col_btn2.button("ğŸ–¨ï¸ ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°", type="primary"):
            st.session_state['print_mode'] = True
            st.rerun()
        
    if not st.session_state['print_mode']:
        selected_week = st.selectbox("ğŸ“… ì¡°íšŒ ì£¼ì°¨", list(WEEK_MAP.keys()), key="week_select", label_visibility="collapsed")
        st.session_state['selected_week_for_print'] = selected_week
    else:
        selected_week = st.session_state.get('selected_week_for_print', st.session_state.get('week_select', list(WEEK_MAP.keys())[0]))

st.markdown(f'<div class="period-info">ğŸ“… ì¡°íšŒ ê¸°ê°„: {WEEK_MAP[selected_week]}</div>', unsafe_allow_html=True)
st.markdown(f"<div class='update-time'>ìµœì¢… ì§‘ê³„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</div>", unsafe_allow_html=True)

# ë°ì´í„° ë¡œë“œ
# [ìˆ˜ì •] data.pyì—ì„œ ë°˜í™˜í•˜ëŠ” df_top10_sources, published_article_count, df_all_articles_with_metadata ì¶”ê°€ ìˆ˜ì‹  (ì´ 20ê°œ í•­ëª©)
(cur_uv, cur_pv, df_daily, df_weekly, df_traffic_curr, df_traffic_last, 
 df_region_curr, df_region_last, df_age_curr, df_age_last, df_gender_curr, df_gender_last, 
 df_top10, df_raw_all, new_ratio, search_ratio, active_article_count, df_top10_sources, published_article_count, df_all_articles_with_metadata) = data.load_all_dashboard_data(selected_week)

# ê¸°ìë³„ ë°ì´í„° ìƒì„± (ë³¸ëª… ê¸°ì¤€) - ì „ì²´ í™œì„± ê¸°ì‚¬ ê¸°ì¤€
writers_df = data.get_writers_df_real(df_all_articles_with_metadata)

# ë·° ë Œë”ë§
if st.session_state['print_mode']:
    # [ì¸ì‡„ ëª¨ë“œ]
    st.info("ğŸ’¡ ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°: ê° í˜ì´ì§€ë³„ë¡œ ë‚˜ëˆ„ì–´ ì¶œë ¥ë©ë‹ˆë‹¤. (1-2 / 3-1 / 3-2 / 4-5 / 6 / 7)")
    
    st.markdown('<div class="print-preview-layout">', unsafe_allow_html=True)
    
    views.render_summary(df_weekly, cur_pv, cur_uv, new_ratio, search_ratio, df_daily, active_article_count, published_article_count)
    st.markdown("<br>", unsafe_allow_html=True)
    views.render_traffic(df_traffic_curr, df_traffic_last)
    
    st.markdown('<div class="page-break"></div>', unsafe_allow_html=True)
    
    views.render_demo_region(df_region_curr, df_region_last)
    
    st.markdown('<div class="page-break"></div>', unsafe_allow_html=True)
    
    views.render_demo_age_gender(df_age_curr, df_age_last, df_gender_curr, df_gender_last)
    
    st.markdown('<div class="page-break"></div>', unsafe_allow_html=True)
    
    views.render_top10_detail(df_top10)
    st.markdown("<br>", unsafe_allow_html=True)
    # [ìˆ˜ì •] df_top10_sources ì¸ì ì¶”ê°€
    views.render_top10_trends(df_top10, df_top10_sources)
    
    st.markdown('<div class="page-break"></div>', unsafe_allow_html=True)
    
    views.render_category(df_all_articles_with_metadata, selected_week)
    
    st.markdown('<div class="page-break"></div>', unsafe_allow_html=True)
    
    views.render_writer_integrated(writers_df, df_all_articles_with_metadata)
    
    st.markdown('<div class="print-footer">Cook&Chef Weekly Report - Generated by AI System</div>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True) 

else:
    # [ì¼ë°˜ ëª¨ë“œ]
    tabs = st.tabs(["1.ì„±ê³¼ìš”ì•½", "2.ì ‘ê·¼ê²½ë¡œ", "3.ë°©ë¬¸ìíŠ¹ì„±", "4.Top10ìƒì„¸", "5.Top10ì¶”ì´", "6.ì¹´í…Œê³ ë¦¬", "7.ê¸°ì(í†µí•©)"])
    
    with tabs[0]: views.render_summary(df_weekly, cur_pv, cur_uv, new_ratio, search_ratio, df_daily, active_article_count, published_article_count)
    with tabs[1]: views.render_traffic(df_traffic_curr, df_traffic_last)
    with tabs[2]: 
        views.render_demo_region(df_region_curr, df_region_last)
        st.markdown("---")
        views.render_demo_age_gender(df_age_curr, df_age_last, df_gender_curr, df_gender_last)
    with tabs[3]: views.render_top10_detail(df_top10)
    # [ìˆ˜ì •] df_top10_sources ì¸ì ì¶”ê°€
    with tabs[4]: views.render_top10_trends(df_top10, df_top10_sources)
    with tabs[5]: views.render_category(df_all_articles_with_metadata, selected_week)
    with tabs[6]: views.render_writer_integrated(writers_df, df_all_articles_with_metadata)

st.markdown('<div class="footer-note no-print">â€» ë³¸ ë³´ê³ ì„œëŠ” ì¿¡ì•¤ì…°í”„(Cook&Chef) í™ˆí˜ì´ì§€ ë° ì• ë„ë¦¬í‹±ìŠ¤ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.</div>', unsafe_allow_html=True)